# Station Inventory Generation Tool

The purpose of this package is to provide tools and workflow for
* generating cleaned up station inventory files for collections of bespoke station records
  (many of which are not in IRIS) in `.STN` files
* retrieving latest IRIS station inventory
* merging multiple inventory files into one
* splitting inventory into per-network files for subsequent conversion to Seiscomp3 sc3ml format


## Requirements

The Python library requirements for using the tools and workflow of this package
are listed in `requirements.txt`. The package is written for Python version 2.7
or >=3.5. To install the library requirements, run

&nbsp;&nbsp;&nbsp;&nbsp;`pip install -r requirements.txt`

Scripts that convert inventory files to sc3ml format also require Seiscomp3 to be installed on the
host system and to be visible in the PATH. The installation of Seiscomp3 generally requires admin
privileges and configuration by a knowledgable user.


### Performance note

Version 1.1.0 of the obspy library has a severe performance problem scaling up
reading of large sc3ml inventory files at the size of data we typically process.
Geoscience Australia has produced [a fix for this issue](https://github.com/medlin01GA/obspy.git),
enabling users to use the patched version. Until the release of future version of obspy
incorporating this patch, produce a custom build of obspy to allow runtime in the
order of minutes rather than many hours for loading sc3ml IRIS inventory files.


## Workflow

The following commands should be run from the hiperseis library root:
1. Produce reference data file IRIS station inventory in sc3ml format:
    `python seismic/inventory/update_iris_inventory.py --output IRIS-ALL.xml`
2. Run station cleanup script to convert `.STN` files into FDSN station XML format,
    passing in IRIS inventory as input:
    `python seismic/inventory/engd2stxml.py --iris IRIS-ALL.xml --stations-path seismic/inventory/stations --output-path seismic/inventory`
    This given IRIS inventory here is only used to extract nominal instrument responses, the
    merging with IRIS records is *not* done here.
3. Merge the IRIS records with the STN records under a single inventory with merged
    network codes where applicable:
    `python seismic/inventory/inventory_merge.py --iris-inv IRIS-ALL.xml --custom-inv <STNFILE> --output-file IRIS-STN-MERGE.xml`
    where `<STNFILE>` is the output file `INVENTORY_<ts>.xml` (`<ts>` is a timestamp in the file name) generated by script `engd2stxml.py`.
4. Split the merged inventory into per-network files:
    `python seismic/inventory/inventory_split.py --inv-file IRIS-STN-MERGE.xml --output-folder networks`
5. Convert the FDSN per-network station XML files to Seiscomp3 format:
    `python seismic/inventory/fdsnxml_convert.py networks networks_sc3ml`

Actual file names may of course differ to the example workflow above - adapt to the user's workflow requirements.
Note: in the call to `update_iris_inventory.py`, additional options are available to
narrow the scope of query to IRIS online database if desired.


## Input file formats

The station input files under the `stations` subfolder are a collection of bespoke `.STN` files generated and curated by
Geoscience Australia (see [future development roadmap][#future]). There are two file
formats (despite having common `.STN` filename extension):
- Networkless STN format: files `stations/BMG.STN` and `stations/ISC.STN`
- Networked STN format: files `stations/ehb.stn` and `stations/iscehb.stn`

The IRIS inventory file passed into `engd2stxml.py` can be any station inventory format
supported by Obspy. By default the `update_iris_inventory.py` script generates this in FDSN station XML
format.

### Networkless STN format

This file format consists of fixed width metadata fields having following format:
```
 SMPI                                                       -1.9810  138.7100      0.0   2005001  2286324  I
 SMRI  GEOFON Station SemJava, Indonesia                    -7.0492  110.4407      0.0   2005001  2286324  I
 SNAA  GEOFON/AWI StationAntarctica                        -71.6707   -2.8379      0.0   2005001  2286324  I
 SPSI                                                       -3.9646  119.7691      0.0   2005001  2286324  I
 SRBI                                                       -8.0848  115.2126      0.0   2005001  2286324  I
 STKA  Stephens Creek    NSW                               -31.8769  141.5952      0.0   2005001  2286324  I
```
Each row is a new station record with station code, coordinates and elevation. Other fields are
ignored, notably the dates which are not considered reliable. Since there are no network codes,
no dates and no channel data, a default network code of `GE` is applied, date fields are left empty
and a default channel code of `BHZ` is applied to each record. See source code of function
`engd2stxml.read_eng()` for more details.

### Networked STN format

This format consists of interleaved station header/location rows, followed optionally by an
arbitrary number of channel metadata rows. Each header row contains a station code, location,
elevation and station start/end dates. Each channel row adds alternate station code, a network
code, a channel code and start/end dates for that channel.
```
LMG      -8.9077  148.1500  1200.0 1971-01-10 07:17:04
LMGC     20.0637  -77.0050   307.0 1999-10-16 09:46:48 2000-01-20 06:13:03
LMGC     20.0637  -77.0050     0.0 2000-01-20 06:13:03
             FDSN LMGC   CW -- HHZ 1998-01-01 00:00:00 2599-12-31 23:59:59
             FDSN LMGC   CW 00 HHZ 1998-01-01 00:00:00 2010-09-01 00:00:00
             FDSN LMGC   CW 00 HHZ 2010-09-01 00:00:00 2599-12-31 23:59:59
LMHM     41.5780 -121.6570  2228.0 1985-04-10 20:37:37
LMI      54.2197   -3.3070   140.0 1992-09-26 05:45:52
LMK      53.4563   -0.3270   130.0 1992-05-21 05:00:00
             FDSN LMK    GB -- BHZ 2009-07-19 00:00:00 2599-12-31 23:59:59    50
             FDSN LMK    GB -- HHZ 2009-07-19 00:00:00 2599-12-31 23:59:59   100
LML      -6.7347  147.0090   100.0 1979-09-04 13:36:51
```
The channel rows (only) specify a network code, and repeat the station code which may or may not
match the station code stated in the preceding header row. Since standalone header rows do not
state a network code, all header rows are treated as distince records and assigned default network
code `IR` and channel code `BHZ`. If channel rows are present, they are treated as distinct channel
records with their own station and networks codes, but add channel dates and take their coordinates
from the preceding header row. For more details consult source code function
`engd2stxml.read_isc()`.


## Output artifacts

The station inventory cleanup script `engd2stxml.py` produces the following output artifacts:

| FILE NAME(S) | DESCRIPTION |
|--------------|-------------|
|INVENTORY_YYYYMMDDThhmmss.xml | FDSN station XML file final output|
|INVENTORY_YYYYMMDDThhmmss.csv | Re-loadable inventory database in tabular CSV|
|INVENTORY_YYYYMMDDThhmmss.h5  | Re-loadable inventory database in tabular hdf5 under key "inventory"|
|INVENTORY_YYYYMMDDThhmmss.txt | Human readable inventory database in fixed with tabular text format|
|LOG_LOCATION_DUPES_YYYYMMDDThhmmss.txt<BR>LOG_CODE_DUPES_YYYYMMDDThhmmss.txt | Log files of duplicate records removed|
|stations/*.pkl                | As a side effect, cached `.pkl` files alongside `.STN` files used as input|

*Beware:* whenever a `.STN` file is changed, any corresponding `.pkl` file should be deleted manually
to force a regeneration of the `.pkl` file.


## Future development roadmap <a name="future"></a>

Agenda for future development:
* Factor out the STN file readers into a separate module so that any reader can be
  substituted, as long as it generates Pandas DataFrame output, to support arbitrary
  input file formats.
* Performance improvements reading files in function `engd2stxml.read_isc()`. E.g. change
  header rows to include a number at the end indicating the number of subsequent channel
  rows for that station location. This will allow channel rows to be loaded in bulk instead
  of one at a time.


## Last known good configuration

Python:
```
Python 3.6.7 (default, Dec  5 2018, 15:02:05)
[GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]
```

Seiscomp3 fdsnxml2inv converter:
```
fdsnxml2inv: Jakarta 2017.124
API version: 10.0.0
GIT HEAD: 89a1a1a
Compiler: c++ (GCC) 4.8.2 20140120 (Red Hat 4.8.2-16)
Build system: Linux 3.10.0-123.el7.x86_64
OS: CentOS Linux release 7.0.1406 (Core) / Linux
```
