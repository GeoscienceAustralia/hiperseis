# Cross-Correlation Workflow

The cross-correlation functionality works off of a FederatedASDF_Dataset source. Users specify two subsets of stations (or * for all stations available in the ASDF files) either as command-line arguments or as separate text-files to be cross-correlated. Depending on the parameterization, a Cartesian product of two lists of station-names defines station-pairs that are to be cross-correlated -- see `correlator.py` for details.

Cross-correlation results are written out as NetCDF-4 files for each station-pair. Interrogating cross-correlation results requires interactive visualization capabilities. [Panoply], a freely available cross-platform tool, which is also available on NCI VDIs, can be used to visualize the results interactively. A quick intro to [Panoply] is available [here].

## Setting up NCI Gadi environment for running cross-correlations

These instructions are for users of the National Computational Infrastructure (NCI) facility at the
Australian National University. The recommended Python environment setup process, within 
an individual user's account, is as follows: 

### Order of operations

To set up the Python environment, the following high level order of operations must be observed:
* Load modules
* Build and install customized 3rd party Python libraries for MPI
* Install standard 3rd party Python libraries

### Library version summary

* Open MPI v2.1.6-mt
* HDF5 v1.10.5p (parallel build)
* mpi4py v3.0.3 (custom MPI build)
* numpy 1.18.5
* cython 0.29.22  
* osbpy 1.1.0
* click 7.0
* netCDF4 1.4.0
* h5py 2.10.0 (custom MPI build)
* pyasdf 0.5.1
* pyFFTW 0.12.0

### Limitations

Due to the limited number of python versions and natively-compiled versions of core libraries (MPI, HDF5, etc.) available on Gadi, the recommended approach is to use the system-provided python3.6 and install dependencies in user space (`--user` option of `pip`). Alternate combinations of Python and core library dependencies are expected to work, but have not been tested.


### Setup process

From a login node on Gadi:

#### Load requisite modules
  1. `module purge`
  2. `module load pbs` 
  3. `module load python3-as-python`
  4. `module load openmpi/2.1.6-mt`
  5. `module load hdf5/1.10.5p`
  6. `module load fftw3/3.3.8`

#### Setup custom packages

##### Upgrade pip

 1. `pip3.6 install pip==21.1.2 --user`

##### numpy

 1. `pip3.6 install numpy==1.18.5 --user`

##### mpi4py

  1. `MPICC=/apps/openmpi/2.1.6-mt/bin/mpicc pip3.6 install mpi4py --user` Note that we use `pip3.6`, the system-provided pip for python 3.6

##### H5PY

1. `pip3.6 install cython==0.29.22 --user`
2. `git clone --single-branch --branch 2.10.0.gadi_tweaks https://github.com/rh-downunder/h5py.git` Pull a branch (based on version 2.10.0) from a fork of h5py, adapted for Gadi.
3. `cd h5py`
4. `CC=mpicc python setup.py configure --mpi --hdf5=/apps/hdf5/1.10.5p/` Configure with mpi enabled
5. `python setup.py build` Build h5py
6. `python setup.py install --user` Install in user space

##### pyFFTW
  2. `wget https://github.com/pyFFTW/pyFFTW/archive/v0.12.0.tar.gz`
  3. `tar -zxvf v0.12.0.tar.gz`
  4. `cd pyFFTW-0.12.0/`
  5. `python setup.py build_ext --inplace`
  6. `python setup.py install --user`

#### Setup standard packages
  1. `pip3.6 install obspy==1.1.0 --user`
  2. `pip3.6 install click==7.1.2 --user `
  3. `pip3.6 install netCDF4==1.4.0 --user`
  4. `pip3.6 install pyasdf==0.5.1 --user`
  5. `pip3.6 install ordered_set ujson psutil --user`
  6. `pip3.6 install pandas==1.1.5 --user`
  7. `pip3.6 install Rtree==0.9.7 --user`

Date last validated: 10 August 2021

### Setup validation

The Python setup can be tested for running the cross-correlation on Gadi using scripts `validate_xcorr_setup.py`
(Python) and `validate_xcorr_runtime.sh` (shell script) in folder `hiperseis/seismic/xcorqc`. These scripts should
be run directly from that folder, not from another folder.

Firstly, run `python validate_xcorr_setup.py` from the command line. Various output will appear explaining the item
being tested and the result, plus output from Python libraries. If the test succeeds, the last line of output
should read `SUCCESS!`.

Next, run at the command line run `./validate_xcorr_runtime.sh`. You should see various output, mostly warnings. To
confirm successful completion of the test, you should see a file `validation_result/ARMA.CMSA.nc` with a current
file time stamp. If this file is not present or not with a current time stamp, then the test was not successful.


# Visualizing Cross-Correlation Results

As there are many technical aspects to interpreting the time series cross-correlation results
generated by the above Cross-Correlation Workflow, functions are provided to convert `.nc` files
to a standard graphical visualization of the cross-correlation time series.

The following three functions from module `xcorr_station_clock_analysis` are used as entry points
for this purpose:
|Function | Purpose|
|---------|--------|
|`plot_xcorr_file_clock_analysis`| For a single `.nc` file. Does not overlay runtime options. |
|`batch_process_xcorr`| For an iterable set of `.nc` files, plot each. Adds traceability information (runtime configuration parameters).|
|`batch_process_folder`| Run `batch_process_xcorr` on all `.nc` files in a specified folder.|


[Panoply]:https://www.giss.nasa.gov/tools/panoply/
[here]:http://www.meteor.iastate.edu/classes/mt452/EdGCM/Documentation/EdGCM_Panoply.pdf
[FDSN website]:http://www.fdsn.org/networks/detail/AU/
